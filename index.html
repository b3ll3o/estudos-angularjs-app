<html lang="pt-br" ng-app='listaTelefonica'>

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aula 01</title>
    <link rel="stylesheet" href="libs/bootstrap.css">
    <style>
      .jumbotron{
        width: 600px;
        text-align: center;
        margin-left: auto;
        margin-right: auto;
        margin-top: 20px;
      }
      .table{
        margin-top: 20px;
      }
      .btn{
        margin-top: 10px;
      }
      .form-adicionar{
        margin-top: 20px;
      }
      .selecionado{
        background-color: yellow;
      }
      .negrito{
        font-weight: bold;
      }
      .color{
        width: 20px;
        height: 20px;
      }
      .rodape{
        text-align: center;
        font-size: 14px;
        font-weight: bold;
        background-color: green;
        padding: 1rem 0;
      }
      .alert{
        margin-top: 12px;
      }
    </style>
    <script src='libs/angular.js'></script>
    <script>
      angular.module('listaTelefonica', []);
      angular.module('listaTelefonica')
        .controller('listaTelefonicaController', ($scope, $http) => {
          
          $scope.app = 'Lista Telefonica';
          $scope.operadoras = [];
          $scope.contatos = [];

          $scope.adicionarContato = contato => {
            $http.post('http://localhost:3000/api/contatos', contato)
              .then(res => res.data)
              .then(data => {
                $scope.contatoForm.$setPristine();
                delete $scope.contato;
                $scope.contatos = data
              });
            }

          $scope.apagarContatos = contatos => {
            $scope.contatos = contatos.filter(c => {
              if(c.selecionado){
                $http.delete('http://localhost:3000/api/contatos/' + c.id);
                return '';
              }
              return c
            });
          }

          $scope.isContatosSelecionados = contatos => {
            return contatos.some(contato => (
              contato.selecionado
            ));
          }

          $scope.ordenarPor = campo => {
            $scope.criterioOrdenacao = campo;
            $scope.direcaoOrdenacao = !$scope.direcaoOrdenacao;
          }

          const carregaContatos = () => {
            $http.get('http://localhost:3000/api/contatos')
              .then(res => res.data)
              .then(data => $scope.contatos = data);        
          };

          const carregaOperadoras = () => {
            $http.get('http://localhost:3000/api/operadoras')
              .then(res => res.data)
              .then(data => $scope.operadoras = data);
          }

          carregaContatos();
          carregaOperadoras();
        });
    </script>
  </head>

  <body ng-controller='listaTelefonicaController'>
    <div class="jumbotron">
      <h3>{{app}}</h3>
      <input class="form-control"
        type='text' 
        ng-model='criterioDeBusca'
        placeholder="Buscar" />
      <table class="table" ng-show='contatos.length > 0'>
        <tr>
          <th></th>
          <th><a href='' ng-click='ordenarPor("nome")'>Nome</a></th>
          <th><a href='' ng-click='ordenarPor("telefone")'>Telefone</a></th>
          <th><a href='' ng-click='ordenarPor("operadora")'>Operadora</a></th>
          <th><a href='' ng-click='ordenarPor("data")'>Data</a></th>
          <th></th>
        </tr>
        <tr 
          ng-repeat='contato in contatos | filter:{nome: criterioDeBusca} | orderBy: criterioOrdenacao : direcaoOrdenacao'
          ng-class='{"selecionado negrito": contato.selecionado}'>
          <th><input type="checkbox" ng-model='contato.selecionado'/></th>
          <td>{{contato.nome}}</td>
          <td>{{contato.telefone}}</td>
          <td>{{contato.operadora.nome | lowercase}}</td>
          <td>{{contato.data | date:'dd/MM/yyyy HH:mm'}}</td>
          <td>
            <div 
              class="color" 
              ng-style='{"background-color": contato.cor}'>
            </div>
          </td>
        </tr>
      </table>
      <form name='contatoForm' class="form-adicionar">
        <input class='form-control' 
          type='text' 
          ng-model='contato.nome'
          ng-required='true'
          name='nome' />
        <input class='form-control' 
          type='text' 
          ng-model='contato.telefone'
          ng-required='true'
          name='telefone'
          ng-pattern='/^\d{4,5}-\d{4}$/' />
        <select 
          class='form-control'
          ng-model='contato.operadora' 
          ng-options='operadora.nome group by operadora.categoria for operadora in operadoras' 
          ng-required='true'
          name='operadora'>
          <option  value="">Selecione uma operadora</option>
        </select>
        <div 
          class="alert alert-danger" 
          ng-show='contatoForm.nome.$error.required && contatoForm.nome.$dirty'>
          Preencha o campo Nome.
        </div>
        <div 
          class="alert alert-danger" 
          ng-show='contatoForm.telefone.$error.required && contatoForm.telefone.$dirty'>
          Preencha o campo Telefone.
        </div>
        <div 
          class="alert alert-danger" 
          ng-show='contatoForm.telefone.$error.pattern'>
          O campo nome deve ter um formato DDDDD-DDDD.
        </div>
        <div 
          class="alert alert-danger" 
          ng-show='contatoForm.operadora.$invalid && contatoForm.operadora.$dirty'>
          Preencha o campo Operadora.
        </div>
        <button 
          class="btn btn-primary btn-block"
          ng-click='adicionarContato(contato)'
          ng-disabled='contatoForm.$invalid' >
          Adicionar Contato
        </button>
        <button 
          class="btn btn-danger btn-block"
          ng-click='apagarContatos(contatos)'
          ng-disabled='!isContatosSelecionados(contatos)'>
          Apagar Contatos
        </button>
      </form>
    </div>
    <div ng-include='"rodape.html"'></div>
  </body>

</html>